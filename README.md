# LC-CNF
Injecting explicit logical constraints (CNF) into neural network via Straight-Through-Estimators 

## Introduction
This repository provides the codes, instructions, and logs for all the experiments reported in the paper "Efficient Way of Injecting Explicit Logical Constraints into Neural Networks via Straight-Through-Estimators".

## Installation
1. Install Anaconda according to its [installation page](https://docs.conda.io/projects/conda/en/latest/user-guide/install/index.html).
2. Create a new environment using the following commands in terminal.
```bash
conda create -n ste python=3.7
conda activate ste
```
3. Install tqdm and Numpy
```bash
conda install -c anaconda tqdm numpy
```
4. Install Pytorch either with cuda (GPU) support
```bash
conda install pytorch==1.8.1 torchvision==0.9.1 cudatoolkit=11.1 -c pytorch -c conda-forge
```
or for CPU only
```bash
conda install pytorch==1.8.1 torchvision==0.9.1 cpuonly -c pytorch
```

## File/Folder Description
```
.
├── main.py                 # The main script to train neural networks with semantic constraints using STE
├── ste.py                  # STE related classes and functions
├── network.py              # Neural network related classes and functions
├── sat.py                  # CNF related classes and functions
├── inference_trick.py      # The script to run inference trick for Sudoku problems
├── testBenchmark.sh        # The bash file to test all simple benchmark problems
├── problems                # The folder that includes multiple python scripts, one for each problem
├── data                    # The folder that includes all the data
│   ├── hasy                # The operator dataset for apply2x2 problem from NeuroLog
│   ├── palm_sudoku         # The sudoku dataset from RRN (Palm)
│   ├── SATNet_sudoku       # The sudoku dataset from SATNet
│   ├── easy_130k_*.p       # The sudoku dataset from NeurASP (Park 70k)
│   ├── shortestPath.data   # The shortest path problem dataset from Semantic Loss
│   ├── *_train.txt         # The datasets either from NeuroLog or generated by us
├── cnf                     # The folder that includes CNF files for all problems
├── trained                 # The folder that includes all trained models
├── logs                    # The folder that includes some logs of experiments
└── README.md
```
Note that all `.cnf` files in the `cnf` folder are in [DIMACS format](https://people.sc.fsu.edu/~jburkardt/data/cnf/cnf.html) where a clause is defined by listing the index of each positive literal, and the negative index of each negative literal. Indices are 1-based, and for obvious reasons the index 0 is not allowed.

## How to Run
You can test all simple benchmark problems by executing the following command.
```
bash testBenchmark.sh
```

You can also try the following commands to test individual problems. More descriptions about each option are available in `main.py`. 

1. mnistAdd, mnistAdd with batch size 16, mnistAdd2, mnistAdd3
```
python main.py --domain mnistAddcnf --epochs 1 --lr 0.001
python main.py --domain mnistAddcnf --epochs 1 --lr 0.001 --batchSize 16
python main.py --domain mnistAdd2cnf --epochs 1 --lr 0.001 --hyper 1 0.01
python main.py --domain mnistAdd3cnf --epochs 1 --lr 0.001 --hyper 1 0.001
```
Note that the 2 numbers after "--hyper" are the weights for L_cnf and L_bound. As discussed in appendix D, we only need to adjust the weight of L_bound to make the absolute value of raw NN output not too big/small. Similar high accuracy could be achieved with a big range of weights of L_bound.

2. add2x2, apply2x2, member3, member5
```
python main.py --domain add2x2cnf --numData 3000
python main.py --domain apply2x2cnf --numData 3000
python main.py --domain member3cnf --numData 3000
python main.py --domain member5cnf --numData 3000
```

3. sudoku: [Park's CNN](https://github.com/Kyubyong/sudoku) training with STE and testing with [inference trick](https://github.com/Kyubyong/sudoku) on Park (sudokucnf) or Palm dataset (sudokuPalmcnf)
```
python main.py --domain sudokucnf --reg cnf bound --epochs 30 --gpu --bn --checkAcc --bar --folder ./trained --save sudoku
python inference_trick.py --gpu --bn --folder ./trained --domain sudokucnf
python inference_trick.py --gpu --bn --folder ./trained --domain sudokuPalmcnf
```

4. shortestPath
```
python main.py --domain shortestPathcnf --reg cross cnf bound --epochs 500 --lr 0.002 --checkAcc --gpu --batchSize 32 --hyper 0.2 1
```
